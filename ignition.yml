passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCgakqOKbhaZe7ku2SOmHCrOCeAx//4PQy/nB6jSqIv94yDcyTcnxlJGhcoWdDFUzesFSYLvO63qgm5oA7ApFw413+R/M4FKuq4afhakSn8srthpW1gwI148hF+a8ugcz6h+COXEzOBdJLE0EUGcvKlI79+oF3h/egoO/2gLH0Pi5q5WQxkNXHBLUhZX4jU6uwS22ot4ThiAFKluB+/Asfvbd8ghZ0RDI6Q7H/yAKMp3E/CgA+xFQoTwybcUMm3e6ACJWD00yRczWapwv9ohaINac0ssym/3bFJZArW7foFgI0pyR56/s/0hWaGnA/nsTTHWs/HQ+324opm/a+908zv"
storage:
  files:
      # TODO(mcsaucy): this is sad. Stop doing this.
    - path: "/etc/selinux/config"
      contents:
        inline: "SELINUX=permissive\nSELINUXTYPE=targeted"
      mode: 0644
      overwrite: true
    - path: "/etc/hostname"
      contents:
          inline: "node0"
      mode: 0644
    - path: "/opt/bin/k3s"
      contents:
        remote:
            url: "https://github.com/rancher/k3s/releases/download/v1.18.6%2Bk3s1/k3s"
            verification:
                hash:
                    function: sha512
                    sum: 0951e378d9d1525386e3bc5e067d8f256fe4aed16a5827850736ac223cb211213c48278dacf440694715c045673b583647ef0eb9fcf576dd4cc04685e56ee1f5
      mode: 0755
      user:
        name: root
      group:
        name: root

systemd:
  units:

    - name: k3s.service
      enabled: true
      contents: |
        [Unit]
        Description=Lightweight Kubernetes
        Documentation=https://k3s.io
        After=network-online.target

        [Install]
        WantedBy=multi-user.target

        [Service]
        Type=notify
        KillMode=process
        Delegate=yes
        LimitNOFILE=1048576
        LimitNPROC=infinity
        LimitCORE=infinity
        TasksMax=infinity
        TimeoutStartSec=0
        Restart=always
        RestartSec=5s
        EnvironmentFile=/secrets/k3s_env
        ExecStartPre=-/sbin/modprobe br_netfilter
        ExecStartPre=-/sbin/modprobe overlay
        ExecStart=/opt/bin/k3s server \
          --cluster-init \
          --cluster-domain example.com \
    - name: papertrail.service
      enabled: true
      contents: |
        [Unit]
        Description=Papertrail
        After=systemd-journald.service
        Requires=systemd-journald.service

        [Service]
        EnvironmentFile=/secrets/papertrail_env
        ExecStart=/bin/sh -c 'journalctl -f | ncat --ssl "${PAPERTRAIL_HOST}" "${PAPERTRAIL_PORT}"'
        TimeoutStartSec=0
        Restart=on-failure
        RestartSec=5s

        [Install]
        WantedBy=multi-user.target
    - name: uptimerobot-heartbeat.service
      enabled: true
      contents: |
        Description=UptimeRobot Heartbeat
        After=systemd-journald.service
        Requires=systemd-journald.service

        [Service]
        EnvironmentFile=/secrets/uptimerobot_heartbeat_env
        ExecStart=/bin/sh -c 'wget --spider "https://heartbeat.uptimerobot.com/${UPTIMEROBOT_HEARTBEAT_PATH}" >/dev/null 2>&1'
        TimeoutStartSec=0
        Restart=on-failure
        RestartSec=5s

        [Install]
        WantedBy=multi-user.target

    - name: uptimerobot_heartbeat.timer
      enabled: true
      contents: |
        [Unit]
        Description=Run UptimeRobot Heartbeat every 5 minutes
        Requires=uptimerobot-heartbeat.service

        [Timer]
        Unit=uptimerobot-heartbeat.service
        OnUnitInactiveSec=5m
        AccuracySec=10s

        [Install]
        WantedBy=timers.target

    - name: secrets.mount
      enabled: true
      contents: |
        [Unit]
        Description=Secrets

        [Mount]
        What=/dev/disk/by-label/secrets
        Where=/secrets
        Options=ro
        DirectoryMode=0700

        [Install]
        WantedBy=k3s.service

